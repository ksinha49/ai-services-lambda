AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Parent SAM template that includes individual service stacks.

Parameters:
  MilvusHost:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /rag/milvus/host
  MilvusPort:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /rag/milvus/port
  MilvusCollection:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /rag/milvus/collection

Resources:
  IDPService:
    Type: AWS::Serverless::Application
    Properties:
      Location: services/idp/template.yaml

  SummarizationService:
    Type: AWS::Serverless::Application
    Properties:
      Location: services/summarization/template.yaml

  ZipProcessingService:
    Type: AWS::Serverless::Application
    Properties:
      Location: services/zip-processing/template.yaml
      Parameters:
        FileProcessingStepFunctionArn: !GetAtt SummarizationService.Outputs.FileProcessingStepFunctionArn

  VectorDBService:
    Type: AWS::Serverless::Application
    Properties:
      Location: services/vector-db/template.yaml
      Parameters:
        MilvusHost: !Ref MilvusHost
        MilvusPort: !Ref MilvusPort
        MilvusCollection: !Ref MilvusCollection

  RagIngestionService:
    Type: AWS::Serverless::Application
    Properties:
      Location: services/rag-ingestion/template.yaml
      Parameters:
        MilvusInsertFunctionArn: !GetAtt VectorDBService.Outputs.MilvusInsertFunctionArn
        MilvusDeleteFunctionArn: !GetAtt VectorDBService.Outputs.MilvusDeleteFunctionArn
        MilvusUpdateFunctionArn: !GetAtt VectorDBService.Outputs.MilvusUpdateFunctionArn
        MilvusCreateCollectionFunctionArn: !GetAtt VectorDBService.Outputs.MilvusCreateCollectionFunctionArn
        MilvusDropCollectionFunctionArn: !GetAtt VectorDBService.Outputs.MilvusDropCollectionFunctionArn
        BucketName: !GetAtt IDPService.Outputs.BucketName
        TextDocPrefix: !GetAtt IDPService.Outputs.TextDocPrefix

  RagRetrievalService:
    Type: AWS::Serverless::Application
    Properties:
      Location: services/rag-retrieval/template.yaml
      Parameters:
        VectorSearchFunctionArn: !GetAtt VectorDBService.Outputs.VectorSearchFunctionArn
